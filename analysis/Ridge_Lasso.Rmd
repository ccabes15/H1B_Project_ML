---
title: "H1B - Ridge/Lasso"
author: "Jeremy Joy"
date: "2022-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
library(broom)
library(janitor)
library(glmnet)
library(leaps)
library(tidymodels)
```

### Loading Training and Testing Data

```{r}
H1B_dummies_Train <- read_csv("../Data/H1B_Train_Dummies.csv")
H1B_dummies_Test <- read_csv("../Data/H1B_Test_Dummies.csv")
```

### Getting Training and Testing Design Matrix and Response Vector

```{r}
x.train.dummies <- as.matrix(H1B_dummies_Train[,3:ncol(H1B_dummies_Train)])
y.train.dummies <- as.matrix(H1B_dummies_Train[,2])

x.test.dummies <- as.matrix(H1B_dummies_Test[,3:ncol(H1B_dummies_Test)])
y.test.dummies <- as.matrix(H1B_dummies_Test[,2])

```

### Running Ridge Regression

```{r}
set.seed(123)
train_rr_cv_dummies <- cv.glmnet(x.train.dummies, as.factor(y.train.dummies), alpha=0, family = "binomial")

plot(train_rr_cv_dummies)
```

### Finding Prediction MSE and Classification Rate for Ridge

```{r}
pred_test_rr_dummies <- bind_cols(predict(train_rr_cv_dummies, newx = x.test.dummies, s = "lambda.1se", type="response"),
                      predict(train_rr_cv_dummies, newx = x.test.dummies, s = "lambda.min", type="response"))

round(colMeans((pred_test_rr_dummies - y.test.dummies)^2), digits = 2)

Predicted.rr.dummies <- ifelse(pred_test_rr_dummies >= 0.5, 1, 0)[,1]
table(H1B_dummies_Test$CASE_STATUS, Predicted.rr.dummies)

class_rate1 = (table(y.test.dummies, Predicted.rr.dummies)[1, 1] + table(y.test.dummies, Predicted.rr.dummies)[2, 2])/(27738)

1-class_rate1
```

### Running Lasso Regression

```{r}
set.seed(123)
train_lr_cv_dummies <- cv.glmnet(x.train.dummies, as.factor(y.train.dummies), family = "binomial")

#Plotting
plot(train_lr_cv_dummies)

train_lr_cv_dummies$index
#Looking at Coefficients
coef(train_lr_cv_dummies)
```

### Getting Prediction MSE and Classification Rate for Lasso

```{r}
pred_test_lr_dummies <- bind_cols(predict(train_lr_cv_dummies, newx = x.test.dummies, s = "lambda.1se", type="response"),
                      predict(train_lr_cv_dummies, newx = x.test.dummies, s = "lambda.min", type="response"))

round(colMeans((pred_test_lr_dummies-y.test.dummies)^2), digits = 2)

Predicted.lr.dummies <- ifelse(pred_test_lr_dummies >= 0.5, 1, 0)[,1]
table(H1B_dummies_Test$CASE_STATUS, Predicted.lr.dummies)

class_rate2 = (table(y.test.dummies, Predicted.lr.dummies)[1, 1] + table(y.test.dummies, Predicted.lr.dummies)[2, 2])/(27738)

1-class_rate2

```


